<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Online Exam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">

<!-- ================= START SCREEN ================= -->
<div id="startScreen" class="bg-white p-8 rounded shadow w-full max-w-md">
  <h1 class="text-2xl font-bold mb-6 text-center">Online Assessment</h1>

  <label class="block mb-4">
    <span class="text-sm text-gray-600">Roll Number</span>
    <input id="rollInput" class="w-full border p-2 rounded" />
  </label>

  <label class="block mb-6">
    <span class="text-sm text-gray-600">Student Name</span>
    <input id="nameInput" class="w-full border p-2 rounded" />
  </label>

  <button id="startBtn"
    class="w-full bg-blue-600 text-white py-3 rounded font-semibold">
    Start Exam
  </button>
</div>

<!-- ================= EXAM SCREEN ================= -->
<div id="examScreen"
  class="hidden bg-white w-full max-w-3xl p-6 rounded shadow">

  <h1 class="text-2xl font-bold mb-4">Online Assessment</h1>

  <div class="flex justify-between mb-4 text-sm text-gray-600">
    <div id="studentInfo"></div>
    <div id="timer" class="font-mono font-bold text-red-600"></div>
  </div>

  <div id="questionBox"></div>

  <div class="flex justify-between mt-6">
    <button id="prevBtn" class="px-4 py-2 bg-gray-300 rounded">Prev</button>
    <button id="nextBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Next</button>
  </div>

  <button id="submitBtn"
    class="mt-6 w-full py-3 bg-green-600 text-white rounded hidden">
    Submit Exam
  </button>
</div>

<script>
/* ================= CONFIG ================= */
const EXAM_ID = "AI_MIDTERM_01";
const EXAM_DURATION_MIN = 30;
const SUBMIT_URL = "https://script.google.com/macros/s/AKfycbzYdYOoBN9iMCu4vdncL6P-8ZvUJKEY_8OQIQ8RQii1KCe54mMzV5E0WCn3z4hSbGhb/exec";

/* ================= STATE ================= */
let studentId = "";
let studentName = "";

let currentQ = 0;
let answers = {};
let tabSwitchCount = 0;
let fullscreenExitCount = 0;
let pageReloadCount = 0;
let copyPasteAttempts = 0;

let examStartTime;

/* ================= QUESTIONS ================= */
let questions = shuffle([
  {
    id: "q1",
    text: "Which model works best for tabular data?",
    options: ["CNN", "RNN", "Random Forest", "GAN"],
    correct: "Random Forest"
  },
  {
    id: "q2",
    text: "Overfitting usually indicates?",
    options: ["High bias", "High variance", "Low data", "Undertraining"],
    correct: "High variance"
  },
  {
    id: "q3",
    text: "Best metric for imbalanced datasets?",
    options: ["Accuracy", "Precision", "Recall", "F1 Score"],
    correct: "F1 Score"
  }
]);

questions.forEach(q => q.options = shuffle(q.options));

/* ================= START EXAM ================= */
document.getElementById("startBtn").onclick = async () => {
  studentId = document.getElementById("rollInput").value.trim();
  studentName = document.getElementById("nameInput").value.trim();

  if (!studentId || !studentName) {
    alert("Please enter Roll Number and Name");
    return;
  }

  try {
    await document.documentElement.requestFullscreen();
  } catch {
    alert("Fullscreen permission is required to start the exam.");
    return;
  }

  document.getElementById("startScreen").classList.add("hidden");
  document.getElementById("examScreen").classList.remove("hidden");

  document.getElementById("studentInfo").innerText =
    `${studentName} (${studentId})`;

  examStartTime = new Date().toISOString();
  startTimer();
  renderQuestion();
};

/* ================= UI ================= */
function renderQuestion() {
  const q = questions[currentQ];

  document.getElementById("questionBox").innerHTML = `
    <div class="mb-4 font-semibold">
      Q${currentQ + 1}. ${q.text}
    </div>
    ${q.options.map(opt => `
      <label class="block mb-2">
        <input type="radio" name="option" value="${opt}"
          ${answers[q.id] === opt ? "checked" : ""}>
        ${opt}
      </label>
    `).join("")}
  `;

  document.querySelectorAll("input[name='option']").forEach(el => {
    el.onchange = () => answers[q.id] = el.value;
  });

  document.getElementById("prevBtn").disabled = currentQ === 0;
  document.getElementById("nextBtn").innerText =
    currentQ === questions.length - 1 ? "Review" : "Next";

  document.getElementById("submitBtn").classList.toggle(
    "hidden",
    currentQ !== questions.length - 1
  );
}

/* ================= TIMER ================= */
let remaining;
let timerInterval;

function startTimer() {
  remaining = EXAM_DURATION_MIN * 60;

  timerInterval = setInterval(() => {
    remaining--;
    document.getElementById("timer").innerText =
      `${Math.floor(remaining / 60)}:${String(remaining % 60).padStart(2, "0")}`;

    if (remaining <= 0) submitExam();
  }, 1000);
}

/* ================= ANTI-CHEAT ================= */
document.addEventListener("visibilitychange", () => {
  if (document.hidden) tabSwitchCount++;
});

document.addEventListener("fullscreenchange", () => {
  if (!document.fullscreenElement) fullscreenExitCount++;
});

document.addEventListener("copy", e => {
  e.preventDefault();
  copyPasteAttempts++;
});
document.addEventListener("paste", e => {
  e.preventDefault();
  copyPasteAttempts++;
});

window.addEventListener("beforeunload", () => {
  pageReloadCount++;
});

/* ================= NAV ================= */
document.getElementById("prevBtn").onclick = () => {
  if (currentQ > 0) currentQ--, renderQuestion();
};
document.getElementById("nextBtn").onclick = () => {
  if (currentQ < questions.length - 1) currentQ++, renderQuestion();
};
document.getElementById("submitBtn").onclick = submitExam;

/* ================= SUBMIT ================= */
function submitExam() {
  clearInterval(timerInterval);

  const examEndTime = new Date().toISOString();
  const totalTimeSec =
    Math.floor((new Date(examEndTime) - new Date(examStartTime)) / 1000);

  let score = 0;
  questions.forEach(q => {
    if (answers[q.id] === q.correct) score++;
  });

  const payload = {
    student_id: studentId,
    student_name: studentName,
    exam_id: EXAM_ID,
    answers,
    score,
    max_score: questions.length,
    exam_start_time: examStartTime,
    exam_end_time: examEndTime,
    total_time_sec: totalTimeSec,
    avg_time_per_q: totalTimeSec / questions.length,
    tab_switch_count: tabSwitchCount,
    fullscreen_exit_count: fullscreenExitCount,
    page_reload_count: pageReloadCount,
    copy_paste_attempts: copyPasteAttempts,
    integrity_flag:
      tabSwitchCount + fullscreenExitCount + pageReloadCount > 3
        ? "REVIEW" : "OK",
    user_agent: navigator.userAgent,
    screen_resolution: `${screen.width}x${screen.height}`
  };

  fetch(SUBMIT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).finally(() => {
    document.body.innerHTML = `
      <div class="h-screen flex items-center justify-center text-xl font-bold">
        Exam submitted successfully.
      </div>`;
  });
}

/* ================= UTILS ================= */
function shuffle(arr) {
  return [...arr].sort(() => Math.random() - 0.5);
}
</script>

</body>
</html>